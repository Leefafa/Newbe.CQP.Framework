# 开始第一个CQP插件

## 环境要求

- .Net Framework 4.5.2 及以上
- Visual Studio 2015 update 3 及以上(推荐 2017)
- Powershell 3.0 及以上

> 以下内容均采用vs2017作为演示IDE

## 设置powershell 执行权限

以**管理员权限**分别打开x86和x64 Powershell

![powershell截图](assets/001/001-8aacfdfe.png)

执行命令

```powershell
Set-ExecutionPolicy RemoteSigned
```

若出现提示，则输入A确认设置。x86和x64 powershell 都要设置。

## 新建项目

![新建插件项目](assets/001/001-b8b344fa.png)

## 安装Newbe.CQP.Framework

使用nuget安装Newbe.CQP.Framework，注意勾选"包含预发行版"

![nuget安装Newbe.CQP.Framework](assets/001/001-706d8a18.png)

安装过程中出现以下截图，则注意从下拉框中选择名称空间为"Syetem.Runtime.InteropServices"。

点击Configure确认。

**过安装完毕都没有出现此对话框，则说明powershell权限设置失败，请重新设置powershell执行权限！**

![](assets/001/001-194afd3b.png)

## 安装MSBuild.ILMerge.Task

使用nuget安装MSBuild.ILMerge.Task

安装完毕后设置ILMerge.props文件中的ILMergeAllowZeroPeKind为true

```xml
<!-- See ILMerge documentation -->
   <ILMergeAllowZeroPeKind>true</ILMergeAllowZeroPeKind>
```

## 修改CQP插件描述文件

重命名Newbe.CQP.Framework.json为希望的插件名称，此处是使用Newbe.CQP.Plugins.FirstPlugin.json。

## 生成解决方案

则在bin\Debug中生成如下目录结构：

**若未生成以下结构或生成失败，请参照以上步骤重新设置确认！**

```powershell
│  Newbe.CQP.Plugins.FirstPlugin.dll
│  Newbe.CQP.Plugins.FirstPlugin.pdb
│
├─x64
│      Newbe.CQP.Plugins.FirstPlugin.dll
│      Newbe.CQP.Plugins.FirstPlugin.pdb
│
└─x86
        Newbe.CQP.Plugins.FirstPlugin.dll
        Newbe.CQP.Plugins.FirstPlugin.pdb
```

## 新建PluginBase实现类

添加 MainPlugin.cs文件(此类名随意，文件名随意)，继承Newbe.CQP.Framework.PluginBase作为基类。

实现 AppId 抽象属性 作为插件的Id，此处使用Newbe.CQP.Plugins.FirstPlugin。

```csharp
using Newbe.CQP.Framework;

namespace Newbe.CQP.Plugins.FirstPlugin
{
    public class MainPlugin : PluginBase
    {
        public MainPlugin(ICoolQApi coolQApi) : base(coolQApi)
        {
        }
        public override string AppId => "Newbe.CQP.Plugins.FirstPlugin";
    }
}
```

## 重写需要的事件

例如此处想要监听私聊事件，则重写ProcessPrivateMessage函数，并将消息回发给发送者，代码如下:

```csharp
using Newbe.CQP.Framework;

namespace Newbe.CQP.Plugins.FirstPlugin
{
    public class MainPlugin : PluginBase
    {
        public MainPlugin(ICoolQApi coolQApi) : base(coolQApi)
        {
        }
        public override string AppId => "Newbe.CQP.Plugins.FirstPlugin";

        public override int ProcessPrivateMessage(int subType, int sendTime, long fromQQ, string msg, int font)
        {
            //使用CoolQApi将信息回发给发送者
            CoolQApi.SendPrivateMessage(fromQQ, msg);
            return base.ProcessPrivateMessage(subType, sendTime, fromQQ, msg, font);
        }
    }
}
```

## 运行

生成插件项目， 打开酷Q调试模式，复制以下文件酷Q的app目录

- bin\Debug\x86下的Newbe.CQP.Plugins.FirstPlugin.dll
- Newbe.CQP.Plugins.FirstPlugin.json

启动酷Q，启用插件

## 成功！

发送消息给酷Q机器人，你就会收到机器人回发的信息。
